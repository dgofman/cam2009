<?xml version="1.0" encoding="utf-8"?>
<mx:HDividedBox xmlns:mx="http://www.adobe.com/2006/mxml"
				xmlns:home="com.academy.calder.view.admin.home.*"
				xmlns:links="com.academy.calder.view.admin.links.*" styleName="innerView"
				width="100%" height="100%" horizontalGap="6" show="onRefresh()">
	<mx:Script>
		<![CDATA[
			import mx.events.ListEvent;
			import mx.events.CollectionEvent;
			import com.academy.calder.vo.UserVO;
			import com.academy.calder.enum.Gender;
			import com.academy.calder.enum.UserTypes;
			import com.academy.calder.enum.PrivilegeEnum;
			import com.academy.calder.business.Manager;
			import com.academy.calder.business.AMFService;
			import com.academy.calder.enum.AccountStatus;
			import com.academy.calder.enum.MessageStatusEnum;
			
			private static const FIELD_WIDTH:uint = 200;
			private static const DEFAULT_LOCALE:String = "en_US";
			
			[Bindable]
			private var _user:UserVO;
			
			[Bindable]
			private var _localeIndex:uint;
			
			[Bindable]
			private static var _languages:Array;
			
			[Bindable]
			private static var _newrecord:Boolean;

			private function onItemClick(event:ListEvent):void{
				_newrecord = false;
				AMFService.send('CAM.person', [dataGrid.selectedItem.userId], onPersonResult, onFault);
			}
			
			public function onRefresh():void{
				onNew();
				_newrecord = false;
				AMFService.send('CAM.users', [accountStatus && accountStatus.selectedItem ? 
											  accountStatus.selectedItem.value : null], onUserResult, onFault);
			}
			
			private function onSubmit():void{
				if(usePassword.selected && confirm.text != password.text){
					Manager.error(Manager.bundle.getMessage('passwordNotMatch'), Manager.bundle.getMessage('error_password'));
					return;
				}
				AMFService.send('CAM.updateUser', [_user.userId,
												   _user.personId,
												   accountId.text,
												   username.text,
												   (usePassword.selected ? password.text : null),
												   first.text,
												   last.text,
												   namesoundex.text,
												   dob.text,
												   notes.text,
												   lang.selectedItem.localeName,
												   sex.selectedItem.value,
												   typeOf.selectedItem.value,
												   privileges.selectedItem.value,
												   status.selectedItem.value], onSubmitDataResult, onFault);
			}
			
			private function onNew():void{
				_user = new UserVO();
				findLocaleIndex();
				_newrecord = true;
				if(dataGrid) dataGrid.selectedIndex = -1;
			}

			private function onUserResult(result:Object):void{
				dataGrid.dataProvider = result;
			}
			
			private function onPersonResult(result:Object):void{
				_user = new UserVO(result);
				findLocaleIndex();
			}
			
			private function onSubmitDataResult(result:Object):void{
				_user = new UserVO(result);
				findLocaleIndex();
			}
			
			private function onLocaleResult(result:Object):void{
				_languages = result as Array;
				findLocaleIndex();
			}
			
			private function findLocaleIndex():void{
				if(_languages == null){
					AMFService.send('CAM.locale', null, onLocaleResult);
				}else{
					var name:String = (_user && _user.localeName) ? _user.localeName : DEFAULT_LOCALE;
					for(var i:uint = 0; i < _languages.length; i++){
						if(_languages[i].localeName == name){
							_localeIndex = i;
							break;
						}
					}
				}
			}
			
			private function set selectedUsePassword(value:Boolean):void{
				currentState = value ? "passwordState" : "";
			}
		
			private function onFault(fault:Object):void{
				Manager.error(fault.code + ": " + fault.description, Manager.bundle.getMessage('error_users'));
			}
		]]>
	</mx:Script>
	<mx:Binding source="usePassword.selected" destination="selectedUsePassword"/>
	
	 <mx:states>
        <mx:State name="passwordState">
            <mx:AddChild relativeTo="{dobFormItem}" position="before">
                <mx:target>
                	<mx:FormItem label="{Manager.bundle.getMessage('password')}:">
						<mx:TextInput width="{FIELD_WIDTH}" displayAsPassword="true" id="password"/>
					</mx:FormItem>
			</mx:target>
            </mx:AddChild>
            <mx:AddChild relativeTo="{dobFormItem}" position="before">
                <mx:target>
					<mx:FormItem label="{Manager.bundle.getMessage('confirm')}:">
						<mx:TextInput width="{FIELD_WIDTH}" displayAsPassword="true" id="confirm"/>
					</mx:FormItem>
                </mx:target>
            </mx:AddChild>
        </mx:State>
    </mx:states>

	<mx:VBox width="300" height="100%">
		<mx:DataGrid id="dataGrid" width="100%" height="100%" itemClick="onItemClick(event)">
			<mx:columns>
				<mx:Array>
					<mx:DataGridColumn dataField="last" headerText="Last"/>
					<mx:DataGridColumn dataField="first" headerText="First"/>
				</mx:Array>
			 </mx:columns>
		</mx:DataGrid>
		<mx:HBox paddingBottom="5" paddingLeft="5" verticalAlign="middle">
			<mx:Label text="{Manager.bundle.getMessage('filter')}:"/>
			<mx:ComboBox id="accountStatus" width="150" dataProvider="{AccountStatus.listAll}" change="onRefresh()"/>
		</mx:HBox>
	</mx:VBox>
	<mx:VBox width="100%" height="100%">
		<mx:Form width="100%" height="100%">
			<mx:FormItem label="{Manager.bundle.getMessage('first')}:">
				<mx:TextInput width="{FIELD_WIDTH}" text="{_user.first}" id="first"/>
			</mx:FormItem>
			<mx:FormItem label="{Manager.bundle.getMessage('last')}:">
				<mx:TextInput width="{FIELD_WIDTH}" text="{_user.last}" id="last"/>
			</mx:FormItem>
			<mx:FormItem label="{Manager.bundle.getMessage('namesoundex')}:">
				<mx:TextInput width="{FIELD_WIDTH}" text="{_user.namesoundex}" id="namesoundex"/>
			</mx:FormItem>
			<mx:FormItem label="{Manager.bundle.getMessage('username')}:">
				<mx:TextInput width="{FIELD_WIDTH}" text="{_user.username}" id="username"/>
			</mx:FormItem>
			<mx:FormItem>
				<mx:CheckBox id="usePassword" label="{Manager.bundle.getMessage('changePassword')}"
					 selected="{_newrecord}" enabled="{!_newrecord}"/>
			</mx:FormItem>
			<mx:FormItem id="dobFormItem" label="{Manager.bundle.getMessage('dob')}:">
				<mx:TextInput width="{FIELD_WIDTH}" text="{_user.dateOfBirth}" id="dob"/>
			</mx:FormItem>
			<mx:FormItem label="{Manager.bundle.getMessage('accountId')}:">
				<mx:TextInput width="{FIELD_WIDTH}" text="{_user.accountId}" id="accountId"/>
			</mx:FormItem>
			<mx:FormItem label="{Manager.bundle.getMessage('sex')}:">
				<mx:ComboBox dataProvider="{Gender.list}" width="{FIELD_WIDTH}" selectedItem="{_user.sex}" id="sex"/>
			</mx:FormItem>
			<mx:FormItem label="{Manager.bundle.getMessage('userType')}:">
				<mx:ComboBox dataProvider="{UserTypes.list}" width="{FIELD_WIDTH}" selectedItem="{_user.typeOf}" id="typeOf"/>
			</mx:FormItem>
			<mx:FormItem label="{Manager.bundle.getMessage('privileges')}:">
				<mx:ComboBox dataProvider="{PrivilegeEnum.list}" width="{FIELD_WIDTH}" selectedItem="{_user.privileges}" id="privileges"/>
			</mx:FormItem>
			<mx:FormItem label="{Manager.bundle.getMessage('userStatus')}:">
				<mx:ComboBox dataProvider="{AccountStatus.list}" width="{FIELD_WIDTH}" selectedItem="{_user.status}" id="status"/>
			</mx:FormItem>
			<mx:FormItem label="{Manager.bundle.getMessage('language')}:">
				<mx:ComboBox dataProvider="{_languages}" width="{FIELD_WIDTH}" selectedIndex="{_localeIndex}" labelField="language" id="lang"/>
			</mx:FormItem>
			<mx:FormItem label="{Manager.bundle.getMessage('notes')}:">
				<mx:TextArea text="{_user.notes}" id="notes" width="{FIELD_WIDTH}" height="100"/>
			</mx:FormItem>
		</mx:Form>
		<mx:HBox paddingLeft="60" paddingBottom="10">	
			<mx:Button label="{Manager.bundle.getMessage('submit')}" enabled="{dataGrid.selectedIndex != -1}" click="onSubmit()"/>
			<mx:Button label="New..." click="onNew()"/>
		</mx:HBox>
	</mx:VBox>
</mx:HDividedBox>